---
format_version: '23'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: flutter

# Trigger Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ
triggers:
  push:
    - branch: main
      workflow: android_dev
    - branch: staging
      workflow: android_staging
    - branch: production
      workflow: android_prod
  pull_request:
    - source_branch: "*"
      workflow: android_dev

# Workflows
workflows:
  
  # ðŸ”¥ Development Build
  android_dev:
    description: Build Android APK (DEV flavor) Ð´Ð»Ñ Firebase App Distribution
    steps:
    
    # 1. ÐšÐ»Ð¾Ð½ÑƒÐ²Ð°Ñ‚Ð¸ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ñ–Ð¹ Ñ‡ÐµÑ€ÐµÐ· HTTPS
    - git-clone@8:
        inputs:
        - clone_depth: '0'
        - fetch_tags: 'yes'
    
    # 2. Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ð¸ Flutter
    - flutter-installer@0:
        inputs:
        - version: 3.35.3
        - is_update: 'false'
    
    # 3. Cache Dart packages
    - restore-dart-cache@2: {}
    
    # 4. Flutter pub get
    - script@1:
        title: Flutter packages get
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            flutter pub get
    
    # 5. Build Runner Ð´Ð»Ñ env Ñ„Ð°Ð¹Ð»Ñ–Ð²
    - script@1:
        title: Generate env files
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ðŸ“¦ Creating .env files..."
            
            # Create .env.dev
            cat > .env.dev << EOF
            apiUrl=$DEV_API_URL
            firebaseApiKey=$DEV_FIREBASE_API_KEY
            EOF
            
            # Create .env.staging  
            cat > .env.staging << EOF
            apiUrl=$STAGING_API_URL
            firebaseApiKey=$STAGING_FIREBASE_API_KEY
            EOF
            
            # Create .env.prod
            cat > .env.prod << EOF
            apiUrl=$PROD_API_URL
            firebaseApiKey=$PROD_FIREBASE_API_KEY
            EOF
            
            echo "âœ… .env files created"
            
            # Run build_runner
            echo "ðŸ”„ Running build_runner..."
            dart run build_runner build --delete-conflicting-outputs
            
            echo "âœ… Code generation completed"
    
    # 6. âš ï¸ ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ SHA-1 Ð´Ð»Ñ Google Sign-In Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ
    - script@1:
        title: Get Debug SHA-1 (Ð´Ð»Ñ Firebase Console)
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ðŸ”‘ Getting SHA-1 fingerprint for Google Sign-In setup..."
            echo ""
            
            # Bitrise Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ” ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¸Ð¹ debug keystore
            KEYSTORE_PATH="$HOME/.android/debug.keystore"
            
            if [ -f "$KEYSTORE_PATH" ]; then
                SHA1=$(keytool -list -v -keystore "$KEYSTORE_PATH" -alias androiddebugkey -storepass android -keypass android 2>/dev/null | grep SHA1 | awk '{print $2}')
                SHA256=$(keytool -list -v -keystore "$KEYSTORE_PATH" -alias androiddebugkey -storepass android -keypass android 2>/dev/null | grep SHA256 | awk '{print $2}')
                
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo "âš ï¸  IMPORTANT: Add this SHA-1 to Firebase Console"
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "SHA-1:   $SHA1"
                echo "SHA-256: $SHA256"
                echo ""
                echo "ðŸ“ Where to add:"
                echo "   Firebase Console â†’ Project Settings â†’ Your App"
                echo "   â†’ Add Fingerprint â†’ Paste SHA-1"
                echo ""
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                
                # Export Ð´Ð»Ñ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð°Ð½Ð½Ñ Ð² Ð½Ð°ÑÑ‚ÑƒÐ¿Ð½Ð¸Ñ… ÐºÑ€Ð¾ÐºÐ°Ñ…
                envman add --key BITRISE_SHA1 --value "$SHA1"
            else
                echo "âš ï¸  Debug keystore not found at $KEYSTORE_PATH"
                echo "ðŸ”„ Creating default debug keystore..."
                keytool -genkey -v -keystore "$KEYSTORE_PATH" -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US"
            fi
    
    # 7. Save Dart cache
    - save-dart-cache@1: {}
    
    # 8. Build Android APK (DEV flavor - debug)
    - script@1:
        title: Build Android APK (DEV Debug)
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ðŸ”¨ Building Flutter Android APK (DEV flavor, Debug mode)..."
            flutter build apk --debug --flavor dev -t lib/main_dev.dart
            
            APK_PATH="build/app/outputs/flutter-apk/app-dev-debug.apk"
            
            if [ -f "$APK_PATH" ]; then
                echo "âœ… APK built successfully: $APK_PATH"
                ls -lh "$APK_PATH"
                
                # Export Ð´Ð»Ñ Firebase
                envman add --key ANDROID_APK_PATH --value "$BITRISE_SOURCE_DIR/$APK_PATH"
                
                # Copy to deploy dir
                cp "$APK_PATH" "$BITRISE_DEPLOY_DIR/CookingBook-DEV.apk"
                echo "âœ… APK copied to artifacts"
            else
                echo "âŒ APK not found!"
                exit 1
            fi
    
    # 9. Firebase App Distribution (DEV)
    - script@1:
        title: Firebase App Distribution (DEV)
        is_always_run: false
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ðŸ”¥ Uploading DEV build to Firebase App Distribution..."
            
            # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð½Ð°ÑÐ²Ð½Ð¾ÑÑ‚Ñ– Ð²ÑÑ–Ñ… Ð½ÐµÐ¾Ð±Ñ…Ñ–Ð´Ð½Ð¸Ñ… Ð·Ð¼Ñ–Ð½Ð½Ð¸Ñ…
            if [ -z "$FIREBASE_TOKEN" ]; then
                echo "âŒ FIREBASE_TOKEN is not set!"
                echo "Please add it to Bitrise Secrets:"
                echo "  1. Go to Workflow â†’ Secrets"
                echo "  2. Add FIREBASE_TOKEN"
                echo "  3. Get token with: firebase login:ci"
                exit 1
            fi
            
            if [ -z "$FIREBASE_APP_ID_ANDROID" ]; then
                echo "âŒ FIREBASE_APP_ID_ANDROID is not set!"
                echo "Please add it to Bitrise Secrets"
                exit 1
            fi
            
            echo "APK: $ANDROID_APK_PATH"
            echo "App ID: $FIREBASE_APP_ID_ANDROID"
            echo "Token: ${FIREBASE_TOKEN:0:20}..."
            
            if [ ! -f "$ANDROID_APK_PATH" ]; then
                echo "âŒ APK file not found!"
                exit 1
            fi
            
            # Install Firebase CLI
            echo "ðŸ“¦ Installing Firebase CLI..."
            npm install -g firebase-tools
            
            # Verify Firebase CLI
            firebase --version
            
            # Upload to Firebase with explicit token
            echo "ðŸš€ Starting upload..."
            FIREBASE_TOKEN="$FIREBASE_TOKEN" firebase appdistribution:distribute "$ANDROID_APK_PATH" \
              --app "$FIREBASE_APP_ID_ANDROID" \
              --token "$FIREBASE_TOKEN" \
              --groups "testers" \
              --release-notes "ðŸ› DEV Build #$BITRISE_BUILD_NUMBER | Branch: $BITRISE_GIT_BRANCH | Commit: ${GIT_CLONE_COMMIT_HASH:0:7} | âš ï¸ Google Sign-In: Ð´Ð¾Ð´Ð°Ð¹Ñ‚Ðµ SHA-1 ($BITRISE_SHA1) Ð´Ð¾ Firebase Console"
            
            if [ $? -eq 0 ]; then
                echo "âœ… Successfully uploaded to Firebase App Distribution!"
            else
                echo "âŒ Upload failed. Check:"
                echo "  1. FIREBASE_TOKEN is valid"
                echo "  2. FIREBASE_APP_ID_ANDROID is correct"
                echo "  3. Firebase App Distribution is enabled"
                exit 1
            fi
    
    # 10. Deploy Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ–Ð²
    - deploy-to-bitrise-io@2:
        inputs:
        - notify_user_groups: none
        - is_compress: 'false'

  # ðŸ”¶ Staging Build
  android_staging:
    description: Build Android APK (STAGING flavor) Ð´Ð»Ñ Firebase App Distribution
    steps:
    
    - git-clone@8: {}
    
    - flutter-installer@0:
        inputs:
        - version: 3.35.3
        - is_update: 'false'
    
    - restore-dart-cache@2: {}
    
    - script@1:
        title: Flutter packages get
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            flutter pub get
    
    - script@1:
        title: Generate env files
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            cat > .env.dev << EOF
            apiUrl=$DEV_API_URL
            firebaseApiKey=$DEV_FIREBASE_API_KEY
            EOF
            
            cat > .env.staging << EOF
            apiUrl=$STAGING_API_URL
            firebaseApiKey=$STAGING_FIREBASE_API_KEY
            EOF
            
            cat > .env.prod << EOF
            apiUrl=$PROD_API_URL
            firebaseApiKey=$PROD_FIREBASE_API_KEY
            EOF
            
            dart run build_runner build --delete-conflicting-outputs
    
    - save-dart-cache@1: {}
    
    - script@1:
        title: Build Android APK (STAGING Release)
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ðŸ”¨ Building STAGING APK..."
            flutter build apk --release --flavor staging -t lib/main_staging.dart
            
            APK_PATH="build/app/outputs/flutter-apk/app-staging-release.apk"
            
            if [ -f "$APK_PATH" ]; then
                envman add --key ANDROID_APK_PATH --value "$BITRISE_SOURCE_DIR/$APK_PATH"
                cp "$APK_PATH" "$BITRISE_DEPLOY_DIR/CookingBook-STAGING.apk"
                echo "âœ… STAGING APK ready"
            else
                echo "âŒ APK not found!"
                exit 1
            fi
    
    - script@1:
        title: Firebase App Distribution (STAGING)
        is_always_run: false
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            if [ -z "$FIREBASE_TOKEN" ] || [ -z "$FIREBASE_APP_ID_ANDROID" ]; then
                echo "âŒ Missing FIREBASE_TOKEN or FIREBASE_APP_ID_ANDROID"
                exit 1
            fi
            
            npm install -g firebase-tools
            
            FIREBASE_TOKEN="$FIREBASE_TOKEN" firebase appdistribution:distribute "$ANDROID_APK_PATH" \
              --app "$FIREBASE_APP_ID_ANDROID" \
              --token "$FIREBASE_TOKEN" \
              --groups "testers" \
              --release-notes "ðŸ”¶ STAGING Build #$BITRISE_BUILD_NUMBER | Branch: $BITRISE_GIT_BRANCH | Commit: ${GIT_CLONE_COMMIT_HASH:0:7}"
    
    - deploy-to-bitrise-io@2:
        inputs:
        - notify_user_groups: none

  # ðŸš€ Production Build  
  android_prod:
    description: Build Android APK (PROD flavor) Ð´Ð»Ñ Firebase App Distribution
    steps:
    
    - git-clone@8: {}
    
    - flutter-installer@0:
        inputs:
        - version: 3.35.3
        - is_update: 'false'
    
    - restore-dart-cache@2: {}
    
    - script@1:
        title: Flutter packages get
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            flutter pub get
    
    - script@1:
        title: Generate env files
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            cat > .env.dev << EOF
            apiUrl=$DEV_API_URL
            firebaseApiKey=$DEV_FIREBASE_API_KEY
            EOF
            
            cat > .env.staging << EOF
            apiUrl=$STAGING_API_URL
            firebaseApiKey=$STAGING_FIREBASE_API_KEY
            EOF
            
            cat > .env.prod << EOF
            apiUrl=$PROD_API_URL
            firebaseApiKey=$PROD_FIREBASE_API_KEY
            EOF
            
            dart run build_runner build --delete-conflicting-outputs
    
    - save-dart-cache@1: {}
    
    - script@1:
        title: Build Android APK (PROD Release)
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            echo "ðŸ”¨ Building PRODUCTION APK..."
            flutter build apk --release --flavor prod -t lib/main_prod.dart
            
            APK_PATH="build/app/outputs/flutter-apk/app-prod-release.apk"
            
            if [ -f "$APK_PATH" ]; then
                envman add --key ANDROID_APK_PATH --value "$BITRISE_SOURCE_DIR/$APK_PATH"
                cp "$APK_PATH" "$BITRISE_DEPLOY_DIR/CookingBook-PROD.apk"
                echo "âœ… PRODUCTION APK ready"
            else
                echo "âŒ APK not found!"
                exit 1
            fi
    
    - script@1:
        title: Firebase App Distribution (PROD)
        is_always_run: false
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e
            
            if [ -z "$FIREBASE_TOKEN" ] || [ -z "$FIREBASE_APP_ID_ANDROID" ]; then
                echo "âŒ Missing FIREBASE_TOKEN or FIREBASE_APP_ID_ANDROID"
                exit 1
            fi
            
            npm install -g firebase-tools
            
            FIREBASE_TOKEN="$FIREBASE_TOKEN" firebase appdistribution:distribute "$ANDROID_APK_PATH" \
              --app "$FIREBASE_APP_ID_ANDROID" \
              --token "$FIREBASE_TOKEN" \
              --groups "testers" \
              --release-notes "ðŸš€ PRODUCTION Build #$BITRISE_BUILD_NUMBER | Branch: $BITRISE_GIT_BRANCH | Commit: ${GIT_CLONE_COMMIT_HASH:0:7}"
    
    - deploy-to-bitrise-io@2:
        inputs:
        - notify_user_groups: none

app:
  envs:
  - BITRISE_FLUTTER_PROJECT_LOCATION: "."
    opts:
      is_expand: false
  - FLUTTER_VERSION: stable
    opts:
      is_expand: false
  # Environment variables (add these to Bitrise Secrets)
  # DEV_API_URL: https://dev.api.example.com
  # DEV_FIREBASE_API_KEY: dev_key
  # STAGING_API_URL: https://staging.api.example.com
  # STAGING_FIREBASE_API_KEY: staging_key
  # PROD_API_URL: https://prod.api.example.com
  # PROD_FIREBASE_API_KEY: prod_key
  # FIREBASE_TOKEN: your_firebase_token
  # FIREBASE_APP_ID_ANDROID: 1:86476150805:android:2a8f3ee4551f2d13e9561c

meta:
  bitrise.io:
    stack: linux-docker-android-22.04
